# 数据库使用说明

## 概述

系统使用 **PostgreSQL** 作为唯一数据库，支持本地开发和云端部署。

## 数据库环境

| 环境 | 数据库类型 | 连接方式 |
|------|-----------|---------|
| **本地开发** | PostgreSQL | 本地 Mac 上的 PostgreSQL |
| **演示环境** | PostgreSQL | 阿里云 RDS PostgreSQL |
| **生产环境** | PostgreSQL | 阿里云 RDS PostgreSQL |

## 快速开始

### 1. 安装 PostgreSQL（本地开发）

如果还没有安装 PostgreSQL：

```bash
# macOS 使用 Homebrew 安装
brew install postgresql@16
brew services start postgresql@16

# 创建数据库
createdb sysafari_logistics
```

### 2. 配置环境变量

在 `server/` 目录下创建 `.env` 文件：

```env
# 本地开发环境
DATABASE_URL=postgresql://localhost:5432/sysafari_logistics

# 或者连接到阿里云 RDS 测试数据库
# DATABASE_URL_TEST=postgresql://用户:密码@pgm-xxx.pg.rds.aliyuncs.com:5432/数据库名?sslmode=require
```

### 3. 初始化数据库表

```bash
cd server

# 安装依赖
npm install

# 初始化数据库（创建表结构和初始数据）
npm run init-db
```

### 4. 启动后端服务器

```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务器将在 http://localhost:3001 启动

### 5. 启动前端

从项目根目录：

```bash
npm run dev
```

或者同时启动前后端：

```bash
npm run dev:all
```

## 数据库连接配置

### 环境变量优先级

1. `DATABASE_URL` - 直接指定的连接字符串（最高优先级）
2. `DATABASE_URL_PROD` - 生产环境（NODE_ENV=production 时使用）
3. `DATABASE_URL_TEST` - 测试/开发环境（NODE_ENV=development 时使用）

### 连接字符串格式

```
postgresql://用户名:密码@主机:端口/数据库名?sslmode=require
```

本地连接示例：
```
postgresql://localhost:5432/sysafari_logistics
```

阿里云 RDS 连接示例：
```
postgresql://user:password@pgm-xxx.pg.rds.aliyuncs.com:5432/logistics_db?sslmode=require
```

## 数据库表结构

### 核心业务表

| 表名 | 说明 |
|------|------|
| `bills_of_lading` | 提单 |
| `packages` | 包裹 |
| `declarations` | 报关 |
| `labels` | 标签 |
| `last_mile_orders` | 最后一公里订单 |
| `operation_logs` | 操作日志 |

### 基础数据表

| 表名 | 说明 |
|------|------|
| `shipping_companies` | 船公司 |
| `container_codes` | 集装箱代码 |
| `ports_of_loading` | 装货港 |
| `destination_ports` | 目的港 |
| `air_ports` | 机场 |
| `countries` | 国家 |
| `transport_methods` | 运输方式 |
| `vat_rates` | 增值税率 |
| `tariff_rates` | 关税税率 |
| `service_fee_categories` | 服务费类别 |

### 系统管理表

| 表名 | 说明 |
|------|------|
| `users` | 用户 |
| `roles` | 角色 |
| `permissions` | 权限 |
| `role_permissions` | 角色权限关联 |
| `system_settings` | 系统设置 |

### 客户/财务表

| 表名 | 说明 |
|------|------|
| `customers` | 客户 |
| `customer_contacts` | 客户联系人 |
| `fees` | 费用 |
| `invoices` | 发票 |
| `payments` | 付款记录 |

## API 接口

### 健康检查
```
GET /api/health
```

### 提单接口

```bash
# 获取提单列表
GET /api/bills?page=1&pageSize=10&type=schedule&search=关键词

# 获取提单详情
GET /api/bills/:id

# 创建提单
POST /api/bills

# 更新提单
PUT /api/bills/:id

# 删除提单
DELETE /api/bills/:id
```

## 数据备份

### 使用 pg_dump 备份

```bash
# 备份到文件
pg_dump -h localhost -U postgres sysafari_logistics > backup.sql

# 从备份恢复
psql -h localhost -U postgres sysafari_logistics < backup.sql
```

### 阿里云 RDS 备份

阿里云 RDS PostgreSQL 提供自动每日备份功能，可在控制台中管理：
- 登录阿里云控制台 → RDS → 实例详情 → 备份恢复
- 支持自动备份和手动备份
- 可设置备份保留时间和备份窗口

## 常见问题

### 1. 连接失败

**原因**：数据库未启动或连接字符串错误

**解决**：
```bash
# 检查 PostgreSQL 是否运行
brew services list | grep postgresql

# 启动 PostgreSQL
brew services start postgresql@16

# 检查环境变量
echo $DATABASE_URL
```

### 2. 表不存在

**原因**：数据库未初始化

**解决**：
```bash
cd server
npm run init-db
```

### 3. 权限错误

**原因**：数据库用户权限不足

**解决**：
```bash
# 创建用户并授权
psql -c "CREATE USER myuser WITH PASSWORD 'mypassword';"
psql -c "GRANT ALL PRIVILEGES ON DATABASE sysafari_logistics TO myuser;"
```

## 环境隔离说明

| 环境 | URL | 数据库 | 说明 |
|------|-----|--------|------|
| 生产 | erp.xianfeng-eu.com | 生产数据库 | 真实业务数据 |
| 演示 | demo.xianfeng-eu.com | 演示数据库 | 测试演示数据 |
| 本地 | localhost:5173 | 本地 PostgreSQL | 开发调试数据 |

**注意**：三个环境的数据库完全隔离，数据互不影响。
