name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "=========================================="
            echo "  å¼€å§‹éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒå’Œæ¼”ç¤ºç¯å¢ƒ"
            echo "=========================================="
            
            # ==========================================
            # 1. éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
            # ==========================================
            echo ""
            echo "ğŸ“¦ [1/2] éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ..."
            cd /var/www/sysafari-logistics
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main
            
            # æ›´æ–°åç«¯
            cd server
            npm install --production
            pm2 restart sysafari-prod
            
            # æ„å»ºå‰ç«¯
            cd /var/www/sysafari-logistics
            
            # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆé˜²æ­¢ä½¿ç”¨é”™è¯¯çš„ API åœ°å€ï¼‰
            rm -f .env .env.local .env.production .env.production.local 2>/dev/null || true
            
            # åˆ›å»ºæ­£ç¡®çš„ç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "VITE_API_BASE_URL=https://api.xianfeng-eu.com" > .env.production
            
            # æ¸…é™¤ Vite æ„å»ºç¼“å­˜ç¡®ä¿å…¨æ–°æ„å»º
            rm -rf node_modules/.vite 2>/dev/null || true
            rm -rf dist 2>/dev/null || true
            
            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            npm install
            npm run build
            
            # éƒ¨ç½²å‰ç«¯åˆ° nginx ç›®å½•ï¼ˆå½»åº•æ¸…ç†åå¤åˆ¶ï¼‰
            rm -rf /var/www/prod/dist/*
            cp -r dist/* /var/www/prod/dist/
            
            echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
            
            # ==========================================
            # 2. éƒ¨ç½²æ¼”ç¤ºç¯å¢ƒ
            # ==========================================
            echo ""
            echo "ğŸ“¦ [2/2] éƒ¨ç½²æ¼”ç¤ºç¯å¢ƒ..."
            
            # æ£€æŸ¥æ¼”ç¤ºç¯å¢ƒç›®å½•æ˜¯å¦å­˜åœ¨
            if [ -d "/var/www/demo" ]; then
              cd /var/www/demo
              
              # æ‹‰å–æœ€æ–°ä»£ç 
              git pull origin main
              
              # æ›´æ–°æ¼”ç¤ºåç«¯
              cd server
              npm install --production
              pm2 restart sysafari-demo || echo "âš ï¸ æ¼”ç¤ºç¯å¢ƒ PM2 æœåŠ¡æœªè¿è¡Œï¼Œè·³è¿‡é‡å¯"
              
              echo "âœ… æ¼”ç¤ºç¯å¢ƒåç«¯éƒ¨ç½²å®Œæˆï¼"
            else
              echo "âš ï¸ æ¼”ç¤ºç¯å¢ƒç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¼”ç¤ºç¯å¢ƒéƒ¨ç½²"
            fi
            
            # é‡è½½ nginx
            nginx -s reload
            
            echo ""
            echo "=========================================="
            echo "âœ… å…¨éƒ¨éƒ¨ç½²å®Œæˆï¼"
            echo "  ç”Ÿäº§ç¯å¢ƒ: https://erp.xianfeng-eu.com"
            echo "  æ¼”ç¤ºç¯å¢ƒ: https://demo.xianfeng-eu.com"
            echo "=========================================="

