# 🔐 安全管理指南

本文档介绍系统安全管理功能的使用方法。

## 目录

1. [安全概览](#安全概览)
2. [安全设置](#安全设置)
3. [审计日志](#审计日志)
4. [IP黑名单](#ip黑名单)
5. [活动会话](#活动会话)
6. [数据备份](#数据备份)
7. [数据库迁移](#数据库迁移)

---

## 安全概览

访问路径：`/system/security-center`

安全概览页面提供系统安全状态的快速视图，包括：
- 今日登录失败次数
- 当前活动会话数
- 封禁IP数量
- 最近7天审计记录数
- 最近登录失败的用户列表
- 最后一次备份状态

---

## 安全设置

### 登录安全
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| login_max_attempts | 最大登录尝试次数 | 5 |
| login_lockout_duration | 账号锁定时长（分钟） | 15 |
| login_remember_days | 记住登录状态天数 | 7 |
| login_require_captcha_after | 多少次失败后需要验证码 | 3 |

### 密码策略
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| password_min_length | 密码最小长度 | 8 |
| password_require_uppercase | 需要大写字母 | true |
| password_require_lowercase | 需要小写字母 | true |
| password_require_number | 需要数字 | true |
| password_require_special | 需要特殊字符 | false |
| password_expire_days | 密码有效期（天，0为永不过期） | 90 |

### 会话管理
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| session_timeout | 会话超时时间（分钟） | 30 |
| session_single_login | 单点登录 | false |

### API安全
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| api_rate_limit | API请求速率限制（每分钟） | 100 |
| api_rate_limit_window | 速率限制时间窗口（秒） | 60 |

---

## 审计日志

审计日志记录系统中所有敏感操作，包括：
- 用户登录/登出
- 用户创建/修改/删除
- 权限变更
- 数据导出
- 安全设置变更
- 备份操作

### 支持的查询筛选
- 按用户名搜索
- 按操作类型筛选
- 按时间范围查询
- 按操作结果筛选（成功/失败）

---

## IP黑名单

IP黑名单功能可以阻止特定IP地址访问系统。

### 添加IP到黑名单
1. 点击"添加IP"按钮
2. 输入IP地址（必填）
3. 输入封禁原因（可选）
4. 设置过期时间（可选，留空为永久）

### 移除IP
点击对应IP行的"移除"按钮即可解除封禁。

---

## 活动会话

活动会话页面显示当前所有在线用户的会话信息，包括：
- 用户名和姓名
- 登录IP地址
- 登录时间
- 最后活动时间

### 强制下线
管理员可以强制终止任何用户的会话，点击"强制下线"按钮即可。

---

## 数据备份

### 自动备份
系统默认配置每天凌晨3点自动执行完整备份。

### 手动备份
1. 进入安全管理中心
2. 切换到"数据备份"标签
3. 点击"立即备份"按钮

### 备份设置
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| backup_enabled | 启用自动备份 | true |
| backup_frequency | 备份频率 | daily |
| backup_retention_count | 备份保留份数 | 30 |
| backup_time | 备份时间 | 03:00 |

### 命令行备份
```bash
# 完整备份
node server/scripts/backup-database.js

# 增量备份
node server/scripts/backup-database.js --type incremental

# 查看备份列表
node server/scripts/backup-database.js --list

# 清理过期备份
node server/scripts/backup-database.js --cleanup
```

---

## 数据库迁移

执行安全相关的数据库迁移脚本：

```bash
# 连接到PostgreSQL数据库并执行迁移
psql -h <host> -U <user> -d <database> -f server/scripts/migrate-security.sql
```

该脚本会创建以下表和设置：
1. `login_attempts` - 登录尝试记录表
2. `security_audit_logs` - 安全审计日志表
3. `ip_blacklist` - IP黑名单表
4. `api_rate_limits` - API速率限制记录表
5. `password_history` - 密码历史表
6. `active_sessions` - 活动会话表
7. `backup_records` - 备份记录表
8. 初始化安全设置数据

---

## API接口

### 安全管理API

| 接口 | 方法 | 说明 | 权限 |
|------|------|------|------|
| `/api/security/overview` | GET | 获取安全概览 | admin |
| `/api/security/settings` | GET | 获取安全设置 | admin |
| `/api/security/settings` | PUT | 更新安全设置 | admin |
| `/api/security/audit-logs` | GET | 获取审计日志 | admin |
| `/api/security/ip-blacklist` | GET | 获取IP黑名单 | admin |
| `/api/security/ip-blacklist` | POST | 添加IP到黑名单 | admin |
| `/api/security/ip-blacklist/:ip` | DELETE | 移除IP | admin |
| `/api/security/active-sessions` | GET | 获取活动会话 | admin |
| `/api/security/active-sessions/:id` | DELETE | 终止会话 | admin |
| `/api/security/backups` | GET | 获取备份历史 | admin |
| `/api/security/backups` | POST | 创建备份 | admin |

---

## 安全建议

1. **定期检查审计日志** - 及时发现异常活动
2. **设置强密码策略** - 启用密码复杂度要求
3. **限制登录尝试** - 防止暴力破解
4. **定期备份数据** - 确保数据安全
5. **监控活动会话** - 发现可疑登录
6. **使用IP黑名单** - 阻止恶意访问

---

## 故障排除

### 登录被锁定
如果用户因多次登录失败被锁定，管理员可以：
1. 等待锁定时间过期（默认15分钟）
2. 通过数据库清除该用户的登录尝试记录

### 备份失败
检查以下内容：
1. 数据库连接是否正常
2. 备份目录是否有写入权限
3. 磁盘空间是否充足
4. 查看服务器日志获取详细错误信息

### API速率限制触发
如果正常使用触发了速率限制：
1. 检查是否有异常的API调用
2. 根据实际需求调整 `api_rate_limit` 设置

---

**最后更新**: 2024年12月
